# é¡¹ç›®ç»“æ„è¯´æ˜

## âœ… é‡æ„å®Œæˆ

é¡¹ç›®å·²æˆåŠŸé‡æ„ä¸º**æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åˆ†ç¦»**çš„ç›®å½•ç»“æ„ï¼Œå¹¶å¼•å…¥äº† `base` é€šç”¨åŸºç¡€åº“ã€‚

## ğŸ“‚ æ–°çš„ç›®å½•ç»“æ„

```
chatroom/
â”œâ”€â”€ CMakeLists.txt              # é¡¶å±‚CMakeé…ç½®ï¼ˆå­ç›®å½•ç®¡ç†ï¼‰
â”œâ”€â”€ README.md                   # å®Œæ•´é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ QUICKSTART.md               # å¿«é€Ÿå¼€å§‹æŒ‡å—
â”œâ”€â”€ STRUCTURE.md                # æœ¬æ–‡ä»¶ï¼šé¡¹ç›®ç»“æ„è¯´æ˜
â”œâ”€â”€ .gitignore                  # Gitå¿½ç•¥é…ç½®
â”œâ”€â”€ start_server.sh             # æœåŠ¡å™¨å¯åŠ¨è„šæœ¬
â”œâ”€â”€ start_client.sh             # å®¢æˆ·ç«¯å¯åŠ¨è„šæœ¬
â”‚
â”œâ”€â”€ base/                       # ğŸ§± åŸºç¡€åº“æ¨¡å—ï¼ˆå…±äº«ï¼‰
â”‚   â”œâ”€â”€ CMakeLists.txt          # åŸºç¡€åº“CMakeé…ç½®
â”‚   â”œâ”€â”€ include/                # åŸºç¡€åº“å¤´æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ database.h          # æ•°æ®åº“æ¥å£
â”‚   â”‚   â”œâ”€â”€ database_config.h   # æ•°æ®åº“é…ç½®
â”‚   â”‚   â”œâ”€â”€ database_manager.h  # æ•°æ®åº“ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ mysql_database.h    # MySQLå®ç°
â”‚   â”‚   â”œâ”€â”€ sqlite_database.h   # SQLiteå®ç°
â”‚   â”‚   â”œâ”€â”€ chat_message.h      # æ¶ˆæ¯ç»“æ„å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ logger.h            # æ—¥å¿—æ¥å£
â”‚   â”‚   â””â”€â”€ stream_logger.h     # æµå¼æ—¥å¿—
â”‚   â””â”€â”€ src/                    # åŸºç¡€åº“æºæ–‡ä»¶
â”‚
â”œâ”€â”€ server/                     # ğŸ“¦ æœåŠ¡å™¨æ¨¡å—ï¼ˆç‹¬ç«‹ï¼‰
â”‚   â”œâ”€â”€ CMakeLists.txt          # æœåŠ¡å™¨ä¸“å±CMakeé…ç½®
â”‚   â”œâ”€â”€ include/                # æœåŠ¡å™¨å¤´æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ http_server.h       # HTTPæœåŠ¡å™¨å®ç°
â”‚   â”‚   â”œâ”€â”€ chatroom_server.h   # èŠå¤©å®¤æœåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ server_config.h     # æœåŠ¡å™¨é…ç½®
â”‚   â”œâ”€â”€ src/                    # æœåŠ¡å™¨æºæ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ http_server.cpp
â”‚   â”‚   â”œâ”€â”€ chatroom_server.cpp
â”‚   â”‚   â””â”€â”€ server_main.cpp     # æœåŠ¡å™¨å…¥å£
â”‚   â””â”€â”€ tests/                  # æœåŠ¡å™¨æµ‹è¯•
â”‚       â””â”€â”€ chatroom_test.cpp
â”‚
â”œâ”€â”€ client/                     # ğŸ“± å®¢æˆ·ç«¯æ¨¡å—ï¼ˆç‹¬ç«‹ï¼‰
â”‚   â”œâ”€â”€ CMakeLists.txt          # å®¢æˆ·ç«¯ä¸“å±CMakeé…ç½®
â”‚   â”œâ”€â”€ include/                # å®¢æˆ·ç«¯å¤´æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ chatroom_client.h
â”‚   â””â”€â”€ src/                    # å®¢æˆ·ç«¯æºæ–‡ä»¶
â”‚       â”œâ”€â”€ chatroom_client.cpp
â”‚       â””â”€â”€ client_main.cpp     # å®¢æˆ·ç«¯å…¥å£
â”‚
â””â”€â”€ build/                      # ç¼–è¯‘è¾“å‡ºç›®å½•
    â”œâ”€â”€ base/
    â”‚   â””â”€â”€ libchatroom_base.a  # âœ… åŸºç¡€é™æ€åº“
    â”œâ”€â”€ server/
    â”‚   â”œâ”€â”€ chatroom_server     # âœ… æœåŠ¡å™¨å¯æ‰§è¡Œæ–‡ä»¶
    â”‚   â””â”€â”€ chatroom_test       # âœ… æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
    â””â”€â”€ client/
        â””â”€â”€ chatroom_client     # âœ… å®¢æˆ·ç«¯å¯æ‰§è¡Œæ–‡ä»¶
```

## ğŸ¯ é‡æ„ä¼˜åŠ¿

### 1. **æ¨¡å—åŒ–æ¸…æ™°**
- **Base**: å­˜æ”¾é€šç”¨çš„æ•°æ®åº“ã€æ—¥å¿—ã€é…ç½®ç­‰ç»„ä»¶ï¼Œä¾› Server å’Œ Client å…±äº«ã€‚
- **Server**: ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å’Œç½‘ç»œå¤„ç†ã€‚
- **Client**: ä¸“æ³¨äºç”¨æˆ·äº¤äº’å’Œç½‘ç»œé€šä¿¡ã€‚

### 2. **æ•°æ®åº“å±‚æ¶æ„**
- **æŠ½è±¡æ¥å£**: `Database` çº¯è™šåŸºç±»å®šä¹‰äº†ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£ã€‚
- **å¤šåç«¯æ”¯æŒ**:
  - `SqliteDatabase`: é€‚ç”¨äºå•æœºã€è½»é‡çº§éƒ¨ç½²ï¼ˆé»˜è®¤ï¼‰ã€‚
  - `MysqlDatabase`: é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œæ”¯æŒé«˜å¹¶å‘ã€‚
- **è¿æ¥æ± åŒ–**: MySQL å®ç°æ”¯æŒè¿æ¥æ± ï¼ˆConnection Poolingï¼‰ï¼Œé€šè¿‡ `initial_size` å’Œ `max_size` é…ç½®å¹¶å‘è¿æ¥æ•°ï¼Œæ˜¾è‘—æå‡å¹¶å‘æ€§èƒ½ã€‚
- **çº¿ç¨‹å®‰å…¨**: `DatabaseManager` å•ä¾‹ç®¡ç†æ•°æ®åº“å®ä¾‹ï¼Œå†…éƒ¨å®ç°çº¿ç¨‹å®‰å…¨çš„è¿æ¥è·å–ä¸é‡Šæ”¾ã€‚

### 3. **Multi-Reactor æ¨¡å‹**
- **Master Loop**: è´Ÿè´£ `Acceptor` æ¥å—æ–°è¿æ¥ã€‚
- **Slave Loops**: è´Ÿè´£ `TcpConnection` çš„ IO è¯»å†™ã€‚
- **Task Queue**: ä¸šåŠ¡é€»è¾‘åœ¨ EventLoop çº¿ç¨‹ä¸­å®‰å…¨æ‰§è¡Œã€‚

## ğŸ§­ æ¶æ„é‡æ„ä¸æ¨¡å—åŒ–æ¼”è¿›è®¡åˆ’

> ä»¥ä¸‹æ­¥éª¤ç”¨äºè§„åˆ’åç»­å¯¹æœåŠ¡å™¨æ¶æ„çš„é‡æ„ä¸æ‰©å±•ï¼Œä¿æŒä¸ç°æœ‰åŠŸèƒ½å…¼å®¹ï¼ŒåŒæ—¶ä¸º SIP/FTPã€UDP ç»„æ’­/å¹¿æ’­ä»¥åŠ eventfd/timerfd/signalfd æ‰“ä¸‹åŸºç¡€ã€‚

1. æŠ½è±¡åè®®ä¼šè¯å±‚ï¼ˆIProtocolSessionï¼‰
   - åœ¨ net å±‚å®šä¹‰ç»Ÿä¸€çš„ ProtocolType å’Œ IProtocolSession æ¥å£ã€‚
   - å°†å½“å‰ Http/WebSocket/RTSP çš„è§£æä¸å¤„ç†é€»è¾‘ä» TcpConnection ä¸­ç§»å‡ºï¼Œæ”¹ä¸ºå¯¹åº”çš„ *Session ç±»å®ç°ã€‚
   - åœ¨ TcpConnection ä¸­ä»…ä¿ç•™å­—èŠ‚æµè¯»å†™ä¸åè®®æ¢æµ‹ï¼ˆProtocolDetectorï¼‰ï¼Œæ¢æµ‹åäº¤ç»™å…·ä½“ Session å¤„ç†ã€‚

2. èŠå¤©ä¸šåŠ¡æœåŠ¡åŒ–ï¼ˆChatService + SessionManagerï¼‰
   - å°† /loginã€/sendã€/messagesã€/usersã€/heartbeat çš„çº¯ä¸šåŠ¡é€»è¾‘é›†ä¸­åˆ° ChatServiceã€‚
   - ChatRoomServer åªè´Ÿè´£ç»„è£… HttpServer / WebSocket / RTSP ä¸ ChatService/SessionManagerã€‚
   - ä¸ºæœªæ¥ SIP/FTP ç­‰åè®®é€šè¿‡ç»Ÿä¸€ä¸šåŠ¡æ¥å£æ¥å…¥åšå‡†å¤‡ã€‚

3. ç»Ÿä¸€ fd æŠ½è±¡ä¸äº‹ä»¶æº
   - åœ¨ net å±‚å¢åŠ  UdpSocket å°è£…ï¼Œæ”¯æŒ UDP å•æ’­ã€å¹¿æ’­ã€ç»„æ’­ã€‚
   - å¢åŠ  TimerFdã€EventFdã€SignalFd å°è£…ï¼Œå¹¶é€šè¿‡ Channel æ³¨å†Œåˆ° EventLoopã€‚
   - ç”¨ timerfd æ›¿æ¢å½“å‰åŸºäºçº¿ç¨‹çš„å‘¨æœŸä»»åŠ¡ï¼ˆå¦‚ä¼šè¯æ¸…ç†ï¼‰ï¼Œå®ç°çœŸæ­£â€œå®Œå…¨ fd åŒ–â€çš„äº‹ä»¶å¾ªç¯ã€‚

4. åè®®æ¨¡å—æ‰©å±•ï¼ˆSIP / FTPï¼‰
   - æ–°å¢ sip/ ä¸ ftp/ åè®®ç›®å½•ï¼Œåˆ†åˆ«å®ç° SipSession/FtpSession ä¸å¯¹åº” codecã€‚
   - åœ¨åè®®æ¢æµ‹å™¨ä¸­è¯†åˆ« SIP/FTP é¦–åŒ…ï¼Œåˆ›å»ºå¯¹åº” Sessionï¼Œå¹¶é€šè¿‡ç»Ÿä¸€ä¸šåŠ¡æ¥å£è°ƒç”¨ ChatServiceã€‚
   - ä¿æŒ HTTP/WebSocket/RTSP è¡Œä¸ºä¸å˜ï¼Œé€æ­¥æ·»åŠ  SIP/FTP ç›¸å…³æµ‹è¯•ç”¨ä¾‹ã€‚

5. æµ‹è¯•ä¸è¿ç§»ç­–ç•¥
   - ä¸º SessionManagerã€ChatServiceã€å„åè®® Session ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œç‹¬ç«‹äº socket å±‚ã€‚
   - ä¿ç•™ç°æœ‰é›†æˆæµ‹è¯•ï¼ˆchatroom_testã€protocol_testï¼‰ï¼Œåœ¨é‡æ„è¿‡ç¨‹ä¸­æŒç»­è·‘å›å½’æµ‹è¯•ã€‚
   - æ¯å®Œæˆä¸€æ­¥é‡æ„ï¼Œå…ˆä¿è¯ç¼–è¯‘ä¸æµ‹è¯•é€šè¿‡ï¼Œå†ç»§ç»­ä¸‹ä¸€æ­¥ï¼Œé¿å…å¤§çˆ†ç‚¸å¼ä¿®æ”¹ã€‚

## ğŸ“‹ CMakeç»“æ„

### é¡¶å±‚ CMakeLists.txt
```cmake
# ç®¡ç†å…¨å±€é…ç½®å’Œç¬¬ä¸‰æ–¹åº“
- è®¾ç½®C++20æ ‡å‡†
- ä¸‹è½½spdlogã€nlohmann/jsonã€googletest
- å¼•å…¥ base, server, client å­ç›®å½•
```

### base/CMakeLists.txt
```cmake
# åŸºç¡€åº“é…ç½®
- æŸ¥æ‰¾ SQLite3, MySQL ä¾èµ–
- ç¼–è¯‘ libchatroom_base.a
- å¯¼å‡ºå¤´æ–‡ä»¶è·¯å¾„
```

### server/CMakeLists.txt
```cmake
# æœåŠ¡å™¨æ¨¡å—é…ç½®
- é“¾æ¥ chatroom_base
- ç¼–è¯‘ chatroom_server
```

### client/CMakeLists.txt
```cmake
# å®¢æˆ·ç«¯æ¨¡å—é…ç½®
- é“¾æ¥ chatroom_base
- ç¼–è¯‘ chatroom_client
```
