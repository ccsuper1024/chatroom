# HTTPèŠå¤©å®¤é¡¹ç›®

åŸºäºHTTPåè®®çš„å¤šäººèŠå¤©å®¤ï¼Œä½¿ç”¨C++20å®ç°ã€‚æ”¯æŒå¤šå®¢æˆ·ç«¯åŒæ—¶åœ¨çº¿ã€‚

## ç‰¹æ€§

- ä½¿ç”¨C++20æ ‡å‡†
- åŸºäºHTTPåè®®é€šä¿¡
- JSONæ•°æ®æ ¼å¼
- æ”¯æŒå¤šäººåŒæ—¶åœ¨çº¿
- å‘½ä»¤è¡Œå®¢æˆ·ç«¯
- ä½¿ç”¨CMakeæ„å»º
- é›†æˆæµ‹è¯•æ¡†æ¶ï¼ˆgtestï¼‰
- æ—¥å¿—ç³»ç»Ÿï¼ˆspdlogï¼‰
- ä¸€é”®éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨

## é¡¹ç›®ç»“æ„

```
chatroom/
â”œâ”€â”€ CMakeLists.txt          # é¡¶å±‚CMakeé…ç½®æ–‡ä»¶
â”œâ”€â”€ README.md               # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ QUICKSTART.md           # å¿«é€Ÿå¼€å§‹æŒ‡å—
â”œâ”€â”€ STRUCTURE.md            # é¡¹ç›®ç»“æ„è¯¦ç»†è¯´æ˜
â”œâ”€â”€ DEPLOY.md               # éƒ¨ç½²æ–‡æ¡£ â­
â”œâ”€â”€ .gitignore              # Gitå¿½ç•¥é…ç½®
â”œâ”€â”€ start_server.sh         # æœåŠ¡å™¨å¯åŠ¨è„šæœ¬
â”œâ”€â”€ start_client.sh         # å®¢æˆ·ç«¯å¯åŠ¨è„šæœ¬
â”œâ”€â”€ deploy_client.sh        # å®¢æˆ·ç«¯éƒ¨ç½²è„šæœ¬ â­
â”‚
â”œâ”€â”€ server/                 # æœåŠ¡å™¨ä»£ç ç›®å½•
â”‚   â”œâ”€â”€ CMakeLists.txt      # æœåŠ¡å™¨CMakeé…ç½®
â”‚   â”œâ”€â”€ include/            # æœåŠ¡å™¨å¤´æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ http_server.h
â”‚   â”‚   â”œâ”€â”€ chatroom_server.h
â”‚   â”‚   â””â”€â”€ json_utils.h
â”‚   â”œâ”€â”€ src/                # æœåŠ¡å™¨æºä»£ç 
â”‚   â”‚   â”œâ”€â”€ http_server.cpp
â”‚   â”‚   â”œâ”€â”€ chatroom_server.cpp
â”‚   â”‚   â””â”€â”€ server_main.cpp
â”‚   â””â”€â”€ tests/              # æœåŠ¡å™¨æµ‹è¯•ä»£ç 
â”‚       â””â”€â”€ chatroom_test.cpp
â”‚
â”œâ”€â”€ client/                 # å®¢æˆ·ç«¯ä»£ç ç›®å½•
â”‚   â”œâ”€â”€ CMakeLists.txt      # å®¢æˆ·ç«¯CMakeé…ç½®
â”‚   â”œâ”€â”€ include/            # å®¢æˆ·ç«¯å¤´æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ chatroom_client.h
â”‚   â””â”€â”€ src/                # å®¢æˆ·ç«¯æºä»£ç 
â”‚       â”œâ”€â”€ chatroom_client.cpp
â”‚       â””â”€â”€ client_main.cpp
â”‚
â””â”€â”€ build/                  # ç¼–è¯‘è¾“å‡ºç›®å½•
    â”œâ”€â”€ server/
    â”‚   â”œâ”€â”€ chatroom_server # æœåŠ¡å™¨ç¨‹åº
    â”‚   â””â”€â”€ chatroom_test   # æµ‹è¯•ç¨‹åº
    â””â”€â”€ client/
        â””â”€â”€ chatroom_client # å®¢æˆ·ç«¯ç¨‹åº
```

## ä¾èµ–åº“

- [spdlog](https://github.com/gabime/spdlog) - æ—¥å¿—åº“
- [nlohmann/json](https://github.com/nlohmann/json) - JSONè§£æåº“
- [googletest](https://github.com/google/googletest) - æµ‹è¯•æ¡†æ¶

æ‰€æœ‰ä¾èµ–åº“éœ€è¦åœ¨ç¼–è¯‘å‰æ‰‹åŠ¨ä¸‹è½½åˆ° `third_party` ç›®å½•ã€‚

> âš ï¸ **é‡è¦æç¤º**ï¼šç”±äº `third_party/` ç›®å½•è¢« `.gitignore` å¿½ç•¥ï¼Œæ‹‰å–ä»£ç åå¿…é¡»æ‰‹åŠ¨ä¸‹è½½ä»¥ä¸‹ä¾èµ–åº“çš„æºç ï¼Œå¹¶æ”¾ç½®åœ¨æ­£ç¡®çš„ä½ç½®ï¼Œå¦åˆ™æ— æ³•ç¼–è¯‘ã€‚

è¯·ç¡®ä¿é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `third_party` ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```text
third_party/
â”œâ”€â”€ spdlog/      # git clone https://github.com/gabime/spdlog.git
â”œâ”€â”€ json/        # git clone https://github.com/nlohmann/json.git
â””â”€â”€ googletest/  # git clone https://github.com/google/googletest.git
```

## ç¼–è¯‘

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd chatroom

# åˆ›å»ºæ„å»ºç›®å½•
mkdir build
cd build

# é…ç½®å’Œç¼–è¯‘
cmake ..
make -j$(nproc)
```

## ç”Ÿæˆå‘å¸ƒåŒ…

æ‰“åŒ…ç”Ÿæˆç‹¬ç«‹çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å‹ç¼©åŒ…ï¼š

```bash
./package.sh
```

ç”Ÿæˆçš„åŒ…ä½äº `dist/` ç›®å½•ä¸‹ï¼š
- `dist/chatroom-client-1.0.0.tar.gz`
- `dist/chatroom-server-1.0.0.tar.gz`

## âš™ï¸ é…ç½®ä¸è°ƒä¼˜

æœåŠ¡å™¨é…ç½®æ–‡ä»¶ä½äº `conf/server.yaml` (å¦‚æœä¸å­˜åœ¨å°†ä½¿ç”¨é»˜è®¤å€¼)ã€‚

### 1. æ¨èé…ç½®è¯¦è§£

```yaml
# åŸºç¡€è®¾ç½®
port: 8080

# æ—¥å¿—è®¾ç½®
log_level: info           # ç”Ÿäº§ç¯å¢ƒå»ºè®® info/warnï¼Œè°ƒè¯•ç”¨ debug/trace
log_file: logs/chatroom.log
log_console: true         # ç”Ÿäº§ç¯å¢ƒåå°è¿è¡Œæ—¶å¯å…³é—­
log_max_size: 5242880     # å•ä¸ªæ—¥å¿—æ–‡ä»¶ 5MB
log_max_files: 3          # ä¿ç•™æœ€è¿‘ 3 ä¸ªæ–‡ä»¶

# çº¿ç¨‹æ± è®¾ç½® (0 è¡¨ç¤ºè‡ªåŠ¨æ£€æµ‹)
thread_pool_core: 0       # å»ºè®®è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°
thread_pool_max: 0        # å»ºè®®è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•° * 2 (IOå¯†é›†å‹)
thread_queue_capacity: 1024 # ç­‰å¾…é˜Ÿåˆ—é•¿åº¦

# è¿æ¥ä¿æ´»ä¸æ¸…ç†
check_interval_seconds: 30       # ç©ºé—²è¿æ¥æ£€æŸ¥å‘¨æœŸ
heartbeat_timeout_seconds: 60    # å¿ƒè·³è¶…æ—¶åˆ¤å®šæ—¶é—´
session_cleanup_interval_seconds: 30 # ä¼šè¯æ¸…ç†å‘¨æœŸ

# ä¸šåŠ¡é™åˆ¶
max_message_history: 1000 # å†…å­˜ä¸­ä¿ç•™çš„å†å²æ¶ˆæ¯æ•°
max_message_length: 1024  # å•æ¡æ¶ˆæ¯æœ€å¤§é•¿åº¦
rate_limit_enabled: true  # å¼€å¯é™æµ
rate_limit_window: 60     # é™æµçª—å£(ç§’)
rate_limit_max_requests: 60 # çª—å£å†…æœ€å¤§è¯·æ±‚æ•° (1 QPS)
```

### 2. è°ƒä¼˜æŒ‡å—

#### å¹¶å‘æ€§èƒ½è°ƒä¼˜
- **çº¿ç¨‹æ± **: 
  - å¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œé€‚å½“å¢åŠ  `thread_pool_max` å’Œ `thread_queue_capacity`ã€‚
  - å¦‚æœå‘ç°å“åº”å»¶è¿Ÿé«˜ï¼Œæ£€æŸ¥ `/metrics` ä¸­çš„çº¿ç¨‹æ± ä»»åŠ¡ç§¯å‹æƒ…å†µã€‚
  - æ¨è: `core_threads` = CPUæ ¸æ•°, `max_threads` = CPUæ ¸æ•° * 4 (å¦‚æœå¤§é‡IOé˜»å¡)ã€‚

#### å†…å­˜æ§åˆ¶
- **æ¶ˆæ¯å†å²**: `max_message_history` ç›´æ¥å½±å“å†…å­˜å ç”¨ã€‚æ¯æ¡æ¶ˆæ¯çº¦ 1KBï¼Œ1000æ¡çº¦å ç”¨ 1MBã€‚æ ¹æ®æœåŠ¡å™¨å†…å­˜è°ƒæ•´ã€‚
- **æ—¥å¿—**: é™åˆ¶ `log_max_size` å’Œ `log_max_files` é˜²æ­¢ç£ç›˜å†™æ»¡ã€‚

#### å®‰å…¨é˜²æŠ¤
- **é™æµ**: å¼€å¯ `rate_limit_enabled` é˜²æ­¢æ¶æ„åˆ·å±æˆ– DoS æ”»å‡»ã€‚é»˜è®¤ 60ç§’/60æ¬¡ å¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´ï¼ˆä¾‹å¦‚ 10/sï¼‰ã€‚
- **å¿ƒè·³è¶…æ—¶**: ç¼©çŸ­ `heartbeat_timeout_seconds` å¯ä»¥æ›´å¿«é‡Šæ”¾æ–­å¼€è¿æ¥çš„èµ„æºï¼Œä½†éœ€é…åˆå®¢æˆ·ç«¯å¿ƒè·³é¢‘ç‡ã€‚

é…ç½®é¡¹ä½äº `conf/server.yaml`ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰ï¼š

```yaml
# æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šå»ºè®®è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•° æˆ– CPU æ ¸å¿ƒæ•° * 2ï¼ˆIOå¯†é›†å‹ï¼‰
thread_pool_core: 4

# æœ€å¤§çº¿ç¨‹æ•°ï¼šå»ºè®®è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•° * 4 ~ * 8
thread_pool_max: 16

# ä»»åŠ¡é˜Ÿåˆ—å®¹é‡ï¼šæ ¹æ®å†…å­˜é™åˆ¶å’Œé¢„æœŸç§¯å‹è¯·æ±‚æ•°è®¾ç½®
thread_queue_capacity: 1024
```

### ç›‘æ§æŒ‡æ ‡

æœåŠ¡å™¨æä¾› `/metrics` æ¥å£æš´éœ²è¿è¡Œæ—¶æŒ‡æ ‡ï¼ŒåŒ…æ‹¬çº¿ç¨‹æ± çŠ¶æ€ï¼š

```json
{
  "success": true,
  "thread_pool_queue_size": 0,      // å½“å‰ç­‰å¾…å¤„ç†çš„ä»»åŠ¡æ•°
  "thread_pool_rejected_count": 0,  // å› é˜Ÿåˆ—æ»¡è¢«æ‹’ç»çš„ä»»åŠ¡æ€»æ•°
  "thread_pool_thread_count": 4,    // å½“å‰å·¥ä½œçº¿ç¨‹æ•°
  "active_session_count": 1,
  "session_count": 1,
  "message_count": 10,
  "uptime_seconds": 120,
  ...
}
```

å»ºè®®å®šæœŸé‡‡é›†è¿™äº›æŒ‡æ ‡ï¼Œå½“ `thread_pool_queue_size` æŒç»­è¾ƒé«˜æˆ– `thread_pool_rejected_count` å¢é•¿æ—¶ï¼Œåº”è€ƒè™‘å¢åŠ çº¿ç¨‹æ•°æˆ–æ‰©å®¹é˜Ÿåˆ—ã€‚

## è¿è¡Œ

### æ–¹å¼ä¸€ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰

#### å¯åŠ¨æœåŠ¡å™¨ï¼ˆç»ˆç«¯1ï¼‰
```bash
./start_server.sh        # é»˜è®¤ç«¯å£8080
# æˆ–æŒ‡å®šç«¯å£
./start_server.sh 9000
```

#### å¯åŠ¨å®¢æˆ·ç«¯ï¼ˆç»ˆç«¯2ã€3ã€4...ï¼‰
```bash
./start_client.sh                    # è¿æ¥æœ¬åœ°8080ç«¯å£
# æˆ–æŒ‡å®šæœåŠ¡å™¨
./start_client.sh 127.0.0.1 9000
```

### æ–¹å¼äºŒï¼šç›´æ¥è¿è¡Œç¨‹åº

#### å¯åŠ¨æœåŠ¡å™¨
```bash
cd build
./server/chatroom_server 8080
```

#### å¯åŠ¨å®¢æˆ·ç«¯
```bash
cd build
./client/chatroom_client 127.0.0.1 8080
```

### ä½¿ç”¨è¯´æ˜

1. å¯åŠ¨å®¢æˆ·ç«¯åï¼Œè¾“å…¥ç”¨æˆ·åç™»å½•
2. è¾“å…¥æ¶ˆæ¯å¹¶æŒ‰å›è½¦å‘é€
3. è¾“å…¥ `/quit` é€€å‡ºèŠå¤©å®¤

## ğŸš€ éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨

### å¿«é€Ÿéƒ¨ç½²

ä¸€é”®å°†å®¢æˆ·ç«¯éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨å¹¶è‡ªåŠ¨è¿è¡Œï¼š

```bash
./deploy_client.sh <æœåŠ¡å™¨IP> <ç«¯å£>
```

ç¤ºä¾‹ï¼š
```bash
# éƒ¨ç½²åˆ°192.168.233.128å’Œ192.168.233.132
# è¿æ¥åˆ°æœ¬æœº(192.168.233.1)çš„8080ç«¯å£èŠå¤©æœåŠ¡å™¨
./deploy_client.sh 192.168.233.1 8080
```

### éƒ¨ç½²è¯´æ˜

- ç›®æ ‡æœåŠ¡å™¨ï¼š192.168.233.128, 192.168.233.132
- éƒ¨ç½²ç›®å½•ï¼š`~/code/cplusplus/chatroom`
- å®¢æˆ·ç«¯ä¼šåœ¨screen/tmuxä¼šè¯ä¸­è¿è¡Œï¼ˆæ”¯æŒäº¤äº’ï¼‰

è¯¦ç»†éƒ¨ç½²æ–‡æ¡£è¯·æŸ¥çœ‹ï¼š**[DEPLOY.md](DEPLOY.md)**

## è¿è¡Œæµ‹è¯•

```bash
# åœ¨buildç›®å½•ä¸‹
./server/chatroom_test

# æˆ–ä½¿ç”¨ctest
ctest --output-on-failure
```

## APIæ¥å£

### POST /login
ç™»å½•æ¥å£

è¯·æ±‚ä½“ï¼š
```json
{
    "username": "ç”¨æˆ·å"
}
```

å“åº”ï¼š
```json
{
    "success": true,
    "message": "ç™»å½•æˆåŠŸ",
    "username": "ç”¨æˆ·å"
}
```

### POST /send
å‘é€æ¶ˆæ¯æ¥å£

è¯·æ±‚ä½“ï¼š
```json
{
    "username": "ç”¨æˆ·å",
    "content": "æ¶ˆæ¯å†…å®¹"
}
```

å“åº”ï¼š
```json
{
    "success": true,
    "message": "æ¶ˆæ¯å‘é€æˆåŠŸ"
}
```

### GET /messages
è·å–æ¶ˆæ¯æ¥å£

å“åº”ï¼š
```json
{
    "success": true,
    "messages": [
        {
            "username": "ç”¨æˆ·å",
            "content": "æ¶ˆæ¯å†…å®¹",
            "timestamp": "2026-01-14 15:30:45"
        }
    ]
}
```

### GET /users
è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨

å“åº”ï¼š
```json
{
    "success": true,
    "users": []
}
```

## å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ï¼šå¤šæœºå™¨èŠå¤©

```bash
# æœºå™¨Aï¼ˆæœ¬æœºï¼‰- å¯åŠ¨æœåŠ¡å™¨
./start_server.sh 8080

# æœºå™¨A - éƒ¨ç½²å®¢æˆ·ç«¯åˆ°è¿œç¨‹æœåŠ¡å™¨
./deploy_client.sh 192.168.233.1 8080

# è¿æ¥åˆ°è¿œç¨‹å®¢æˆ·ç«¯è¿›è¡ŒèŠå¤©
ssh 192.168.233.128 -t 'screen -r chatroom'
# è¾“å…¥ç”¨æˆ·åï¼šAlice

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯
ssh 192.168.233.132 -t 'screen -r chatroom'
# è¾“å…¥ç”¨æˆ·åï¼šBob

# ç°åœ¨Aliceå’ŒBobå¯ä»¥èŠå¤©äº†ï¼
```

## å¼€å‘è¯´æ˜

- æœåŠ¡å™¨ä½¿ç”¨ç®€å•çš„HTTP/1.1åè®®å®ç°
- æ¶ˆæ¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ˆé‡å¯åä¸¢å¤±ï¼‰
- å®¢æˆ·ç«¯å®šæ—¶è½®è¯¢è·å–æ–°æ¶ˆæ¯ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
- çº¿ç¨‹å®‰å…¨ï¼šä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å…±äº«æ•°æ®

## æ–‡æ¡£

- [README.md](README.md) - æœ¬æ–‡ä»¶ï¼Œé¡¹ç›®æ¦‚è§ˆ
- [QUICKSTART.md](QUICKSTART.md) - å¿«é€Ÿå¼€å§‹æŒ‡å—
- [STRUCTURE.md](STRUCTURE.md) - è¯¦ç»†çš„é¡¹ç›®ç»“æ„è¯´æ˜
- [DEPLOY.md](DEPLOY.md) - éƒ¨ç½²æ–‡æ¡£

## å¾…æ”¹è¿›

- [ ] å®ç°WebSocketæ”¯æŒï¼Œå®ç°çœŸæ­£çš„å®æ—¶é€šä¿¡
- [ ] æ·»åŠ ç”¨æˆ·èº«ä»½éªŒè¯
- [ ] æŒä¹…åŒ–æ¶ˆæ¯å­˜å‚¨
- [ ] ç»´æŠ¤åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
- [ ] æ·»åŠ ç§èŠåŠŸèƒ½
- [ ] æ”¯æŒæ–‡ä»¶ä¼ è¾“
- [ ] æ·»åŠ æ›´å¤šå•å…ƒæµ‹è¯•

## è®¸å¯è¯

MIT License
